<!doctype html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css?family=Itim|Roboto+Mono:300,400,500,700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="js/lodash.min.js"></script>
<script src="js/d3.v5.min.js"></script>
<script src="js/vue.min.js"></script>

<style>

html, body, #app{
  height: 100%;
  background-color: black;
}

*{
  font-family: 'Roboto Mono', monospace;
  font-size:16px;

  color: white;
}


.fade-enter-active, .fade-leave-active {
  transition: opacity 1s;
}
.fade-enter, .fade-leave-to /* .fade-leave-active below version 2.1.8 */ {
  opacity: 0;
}


.smaller, .smaller *{
  font-size: 16px;
}


h1, h1 *{
  font-size: 60px;
}

.no-select, .no-select *{
  user-select: none;
}

.magic-bar, .magic-bar *{
    user-select: none;
}
.your{
  color: white;
}

.predicted{
  color: #347deb;
}

.true{
  color: red;
}
</style>

</head>

<body>


<div id="app">
<div style="position:relative; padding: 16px; margin-left:100px">

  <h1 class="your">If you were President, how would you allocate the U.S. budget?</h1>

  <div>Tap to allocate {{budgetRemaining.your}} billion dollars</div>

  {{deltaAmount}} {{activeDept}} {{isDragging}}
  <div style="position:relative">
    <div   @mousedown="isDragging = true" 
           @mouseup="isDragging = false" 
           @touchstart="isDragging = true"
           @touchend="isDragging = false"
           @contextmenu="isDragging = false"
           style="border: 1px solid red; "
    >

      <magic-bar v-for="(amount, dept) in allocation.your" section="your" :name="dept" :num-units="Math.max(1, Math.round(amount))"
      @mousemove-from-bar="mousemoveFromBar"
      style="position:relative;"
      :style="{left: -1 * sizeOfLeft + 'px'}">
      </magic-bar>
    </div>

  </div>

  <h1>How do you <span class="predicted">think</span> America allocates its budget?</h1>
  <magic-bar v-for="(amount, dept) in allocation.predicted" 
               :references="['your']"
               section="predicted" :name="dept" :num-units="amount"
               @mousemove-from-bar="mousemoveFromBar">
  </magic-bar>

  <h1>This is how <span class="true">America</span> actually allocates its budget</h1>

  <div style="margin-bottom: 16px">
    <div>$: Your ideal allocation</div>
    <div class="predicted">$: Your predicted U.S. allocation</div>
    <div class="true">$: Actual U.S. allocation</div>
  </div>
  <magic-bar v-for="(amount, dept) in allocation.true" 
             :references="['your', 'predicted']"
             section="true" :name="dept" :num-units="amount">
  </magic-bar>

</div> <!-- end center div -->
</div> <!-- end #app -->

<script type="text/x-template" id="magic-bar-template">
<div class="magic-bar" style="width:100%; margin-bottom: 8px; border:1px solid blue;"
       :style="{'padding-left': $root.sizeOfLeft + 'px'}"
       @mousemove="mousemove""> <!-- outer div is the invisible container listening to mousepress events -->

  <div>{{name}} ${{numUnits}} billion </div>

  <!-- reference -->
  <div v-for="reference in references">
    <span v-for="_ in $root.allocation[reference][name]"
    :class="reference">$</span>
  </div>

  <!-- this is the current one -->
  <div><span v-for="_ in numUnits" :class="section">$</span></div>
</div>
</script>


<script>

// 'yours', 'predicted', 'murica'

const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

// 1279 billions.

// https://docs.google.com/spreadsheets/d/13YXC-Egw7nW5amO3zM98zex6rJc8DbRwe9uSBeEkRu0/edit
// 2020: in billions
var trueDeptToBillions = {
'Agriculture': 20.8,
'Commerce': 12.2,
'Defense': 718,
'Education': 62,
'Energy': 31.7,
'Health & HS': 87.1,
'Homeland Security': 51.7,
'HUD': 44.1,
'Interior': 12.5,
'Justice': 29.2,
'Labor': 10.9,
'State & Intern': 40,
'Transportation*': 21.4,
'Treasury': 12.7,
'Veterans Affairs': 93.1,
'Civil Works': 4.8,
'EPA': 6.1,
'NASA': 21,
};
trueDeptToBillions = _.mapValues(trueDeptToBillions, x => Math.round(x));


const SECTION_TO_COLOR = {
  'your': 'yellow',
  'predicted': 'white', 
  'true': 'red'
}

const AUTO_FLIP_MS = 50;

Vue.component('magic-bar', {
  props: {

    references: {type: Array, default: () => []},
    section: {type: String, default: 'Section'},
    name: {type: String, default: 'Name'},
    numUnits: {type: Number, default: 1},
  },
  methods: {
    mousemove(event){
      // Find the relative X of the mouse event
      var refElement = event.target;
      while (refElement.className !== 'magic-bar'){
        refElement = refElement.parentElement;
      }

      const refX = refElement.getBoundingClientRect().x;
      var clientX = event.clientX;
      if (event.touches){
        clientX = event.touches[0].clientX;
      }

      // todo: may need a buffer
      const distanceFromEdge = clientX - refX; 
      var positiveOrNegative; 
      if (distanceFromEdge < this.$root.sizeOfLeft){
        // This means it's a decrement
        positiveOrNegative = -1;
      } else {
        positiveOrNegative = 1;
      }

      //console.log('refX ' + refX + ' clientX ' + clientX);
      this.$emit('mousemove-from-bar',  {  
        section: this.section, 
        name: this.name, 
        positiveOrNegative: positiveOrNegative,
      });
    }
  },
  template: '#magic-bar-template'
});


// Gotchas:
// DOM does not update for new property additions.
// DOM does not update for direct assignments within arrays.
// https://vuejs.org/2016/02/06/common-gotchas/#Why-isn%E2%80%99t-the-DOM-updating  
new Vue({
  el: '#app',

  computed: {
    budgetRemaining(){
      const total = _.sum(_.values(trueDeptToBillions));
      return {
        'your': total - _.sum(_.values(this.allocation['your'])), 
        'predicted': total - _.sum(_.values(this.allocation['predicted'])), 
      };
    },
    deltaAmount(){
      if (!this.isDragging){
        return 0;
      }
      return this.positiveOrNegative > 0 ? this.positiveOrNegative * this.amountPerDollar : -1;
    }
  },
  watch: {
    isDragging(){
      if (this.isDragging){
        const this_ = this;
        this.autoFlipper = setInterval(function(){
          // increment the value by the delta amount
          // increment the active dept section by
          this_.flip();
        }, AUTO_FLIP_MS);        
      } else {
        if (this.autoFlipper){
          clearInterval(this.autoFlipper);
        }
      }
    }
  },
  data: {
    activeSection: 'your',
    activeDept: null,

    isDragging: false,
    autoFlipper: null,
    amountPerDollar: 5, // Use to change scale per $
    positiveOrNegative: 0, // Use to indicate whether incrementing (1), decrementing (-1), or neither (0)

    allocation: {'your': makeEmpty(), 'predicted': makeEmpty(), 'true': trueDeptToBillions},

    sizeOfLeft: 100,

  },
  methods: {
    flip(){
      if (this.deltaAmount === 0){
        return;
      }

      const oldValue = this.allocation[this.activeSection][this.activeDept];
      this.allocation[this.activeSection][this.activeDept] = Math.max(1, oldValue + this.deltaAmount);
    },

    mousemoveFromBar(params){
      if (!this.isDragging){
        return;
      }

      this.activeSection = params.section;
      this.activeDept = params.name;
      this.positiveOrNegative = params.positiveOrNegative;
    }
  }
});

function makeEmpty(){
  return _.mapValues(trueDeptToBillions, x => 1);
}

function makeRandom(){
  return _.mapValues(trueDeptToBillions, x => 1 + Math.floor(Math.random()*500));
}

// const url = 'https://script.google.com/macros/s/AKfycbwYrMYUdHhgfUC-jMoGzBE2lbz48oPVIsfnkrs1PAVP4ece8Qw/exec';
// var jqxhr = $.ajax({
//   url: url,
//   method: "GET",
//   dataType: "json",

//   // Zomg this is amazing. Matching fields are included. 
//   // Fields not in the spreadsheet are ignored.
//   // Can send numbers as either strings or numbers. Doesn't matter.
//   data: {'field1': 22, 'field2': '1', 'field3': 'd'}
// });
</script>
